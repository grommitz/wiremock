App = Ember.Application.create();

App.Router.map(function() {
  this.resource('mtest', function() {
    this.resource('results', {path: '/results'});
  });
  this.route('about');
  this.route('settings');
});

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// MIXINS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

App.Settings = Ember.Mixin.create({
  matchingThreshold: 0.1,
  init: function() {
    this.set('matchingThreshold', 0.1);
  }
});

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// ROUTES
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
App.IndexRoute = Ember.Route.extend({
  beforeModel: function() {
    this.transitionTo('mtest');
  }
});

App.ResultsRoute = Ember.Route.extend(App.Settings, {
  model: function() {
    return Ember.$.getJSON("http://localhost:8089/logo/test").then(
      function(json) {
        toastr['info']('matching, be patient...');
        return App.SearchResult.create().from(json);
      },
      function(err) {
        toastr['error']('Error fetching results');
      }
    )
  }
})

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// CONTROLLERS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

App.MtestController = Ember.ArrayController.extend(App.Settings, {
  kw: null,
  actions: {
    runTest: function() {
      //var urlz = this.get('urls').split('\n');
      this.transitionToRoute('results');
    }
  }
});

App.ResultsController = Ember.ObjectController.extend(App.Settings, {
  end: function() {
    return this.get('start') + this.get('pageSize') - 1;
  }.property()
});

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// OTHER
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

App.SearchResult = Ember.Object.extend({
  start:0,
  pageSize:0,
  end:0,
  totalResults:0,
  results:null,
  init: function() {
    this.set('results',Em.A());
  },
  from: function(json, searchText) {
    this.set('searchText', searchText);
    this.set('start', json.start + 1);
    this.set('totalResults', json.totalResults);
    this.set('pageSize', json.pageSize);
    var _this=this;
    json.results.forEach(function(r) {
      _this.get('results').pushObject(Ember.Object.create(r));
    })
    return this;
  }
})






